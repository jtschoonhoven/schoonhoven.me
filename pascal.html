<html ng-app>

  <head>
     <script src="./public/javascripts/angular.min.js"></script>
     <script src="./public/javascripts/d3.v3.min.js"></script>
     <style>
        body {
          font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
          font-weight: 500;
          }
     </style>
  </head>

  <body>
    <div ng-controller="PascalCtrl">
      <br/>
      <label>How many rows?</label>
      <input type="number" ng-model="n" value="{{ n }}"></input>
      <br/>
        <input type="checkbox" ng-model="drawLabels" ng-checked="{{drawLabels}}">Draw Labels</input>
        <input type="checkbox" ng-model="drawTriangles" ng-checked="{{drawTriangles}}">Draw Triangles</input>
      <br/>
      <div id="canvas"></div>
    </div>
  </body>

  <script>

    function PascalCtrl($scope) {

      $scope.rows = [[1]];
      $scope.n = function(){ return $scope.rows.length; }();
      $scope.drawLabels = true;
      $scope.drawTriangles = true;
      $scope.$watchCollection('[n, drawLabels, drawTriangles]', function() { $scope.getNRows($scope.n); $scope.draw($scope.rows, $scope.n) });


      $scope.draw = function(data, n) {

        var n = (n>0) ? n : 1;

        // canvas dimensions
        var width = 400
        var height = (Math.sqrt(3)/2) * width;

        // size of sub-triangles, scaled to fit canvas
        var w = width/(data[n-1].length);
        var h = (Math.sqrt(3)/2) * w;

        // only create the svg if it doesn't already exist
        if(!d3.select("svg")[0][0]) {
          var canvas = d3.select("#canvas")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
          }
        else { var canvas = d3.select("svg"); }

        var group = canvas.selectAll("g").data(data);
          group.exit().remove();
          group.enter().append("g");
          group.attr("transform", function(d,i) { return "translate(" +(data.length-(i+1))*w/2+ "," +i*h+ ")" });

        var triangles = group.selectAll(".triangle").data(function(d) { return d; });
          if($scope.drawTriangles) triangles.enter().insert("path", ":first-child")
          else triangles.remove();
          triangles.attr("class", "triangle")
            .transition().duration(300).ease("circle")
            .attr("d", function(d,i) { return "M " +w/2+ " 0 L " +w+ " " +h+ " L 0 " +h+ " z"})
            .attr("transform", function(d,i) {return "translate(" +i*w+ ",0)" } )
            .style("fill", function(d) { return (d%2 || d===1) ? "black" : "white"; });

        var labels = group.selectAll(".label").data(function(d) { return d; });
          if($scope.drawLabels) labels.enter().append("text")
          else labels.remove();          
          labels.attr("class", "label")
            .style("font-weight", 600)
            .transition().duration(300).ease("elastic")
            .attr("text-anchor","middle")
            .attr("x", function() { return w/2; })
            .attr("y", h*.9)
            .attr("transform", function(d,i) {return "translate(" +i*w+ ",0)" } )
            .text(function(d) { return d })
            .style("text-align", "center")
            .style("font-size", function(d) { return (.5*w/(d.toString().length))  + "px"; })
          if($scope.drawTriangles) { labels.style("fill", function(d) { return (d%2 || d===1) ? "white" : "black"; }) }
          else { labels.style("fill", "black"); };

        };


      $scope.getNRows = function(n) {

        var n = (n>0) ? n : 1;

        // while n < rows.length, delete rows
        while(n<$scope.rows.length) {
          $scope.rows.splice($scope.rows.length-1,1);
        };

        // while rows.length < n, add rows
        for(var i=$scope.rows.length; i<n; i++){
          var lastRow = $scope.rows[$scope.rows.length-1];
          var nextRow = addRow(lastRow);
          $scope.rows.push(nextRow);
        };

        // calculate next row
        function addRow(prevRow) {
          var prevRow = prevRow || [1]
          var next = [1];
          for(var i=0; i<prevRow.length; i++) {
            var n1 = prevRow[i] || 0;
            var n2 = prevRow[i+1] || 0;
            next.push(n1 + n2);
          };

          return next;
        };
      };
    };

  </script>

</html>